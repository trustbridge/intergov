# Docker-compose file for the demo purposes
# Once run you get a full local stack that I can use for
# end-to-end integration testing and/or system demos
# Usage: docker-compose -f demo-dc.yml up
# the var directory will be created with some container data, to persist it
# between runs. You may delete it to start afresh
version: '3.5'

# apis_external network should be generated as ntergov-apis-external because
# we say so.
# It's essential to make the whole system run locally.
# All containers attached to apis_external should have unique not autogenerated names.
# App projects rely on them to reach apis endpoints.

networks:
  cnapis_external:
    driver: bridge
    name: cnintergov-apis-external
  cninternal:
    driver: bridge
    name: cnint
  intercountries:
    driver: bridge
    name: intercountries

# using extensions to ignore base containers
x-services:
  base: &base_service
    # just run tests and exit in the base scenario,
    # run some specific service and keep working in other
    build:
      context: .
      dockerfile: ./Dockerfile-demo
    image: cnintergov-demo-base
    depends_on:
      - cnpostgresql
      - cnelasticmq
      - cnminio
    volumes:
      # having this volume allows us to have updated code inside the docker
      # container without rebuilding, but saved artefacts from the container
      # itself to the repo
      # For production-like use it may be disabled
      - ./intergov:/src/intergov
      - ./tests:/src/tests
      - ./htmlcov:/src/htmlcov
    command: bash -c "cd /src && echo "Hello I'm a container""
    networks:
      - cnapis_external
      - cninternal
    env_file:
      - ./demo-default.env
      - ./demo-local.env
      - ./demo-local-cn.env

  base_api: &base_api_service
    <<: *base_service
    networks:
      - cnapis_external
      - cninternal

services:
  # service providers - minio, elasticMQ, postgres
  cnpostgresql:
    image: postgres:10.5
    environment:
      - POSTGRES_USER=intergovuser
      - POSTGRES_PASSWORD=intergovpassword
    # we don't have to expose it directly to the host machine for our demo,
    # but it's useful for starting service on the host
    # ports: ['5432:5432']
    volumes:
      - ./var/cn/postgres-data:/var/lib/postgresql/data
    networks:
      - cninternal
    restart: on-failure

  cnelasticmq:
    image: softwaremill/elasticmq
    # we don't have to expose it directly to the host machine for our demo,
    # but it's useful for starting service on the host
    ports: ['9325:9324']
    volumes: ['./tests/local_elasticmq.conf:/opt/elasticmq.conf']
    logging:
      # because it's noisy
      driver: none
    networks:
      - cninternal
    restart: on-failure

  cnminio:
    # https://docs.min.io/docs/minio-docker-quickstart-guide.html
    image: minio/minio
    command: server /minio-data
    environment:
      - MINIO_ACCESS_KEY=minidemoaccess
      - MINIO_SECRET_KEY=miniodemosecret
      - MINIO_HTTP_TRACE=/minio-data/requests.log
    # we don't have to expose it directly to the host machine for our demo,
    # but it's useful for starting service on the host
    ports: ['9001:9000']
    restart: on-failure
    volumes:
      - ./var/cn/minio-data:/minio-data
    networks:
      - cninternal
  # our services - message API, ....

  # # this service just runs tests at startup
  # tests-unit:
  #   <<: *base_service
  #   container_name: tests-unit
  #   command: bash -c "cd /src && sleep 10 && make test-unit"

  # uncomment to run it on each start. commented because they are slow
  # or just do manually:
  # docker-compose -f demo-dc.yml run tests sh -c "cd /src && py.test --integration"
  # tests-integration:
  #   <<: *base_service
  #   container_name: tests-integration
  #   command: bash -c "cd /src && sleep 10 && make test-integration"


  # used for tests to get responses specific responses.
  # test-server-dummy-test-helper:
  #   <<: *base_service
  #   container_name: dummy-test-helper-server
  #   environment:
  #     - PYTHONPATH=/src/:/src/tests/helpers/servers/
  #   ports: ['5001:5001']
  #   command: bash -c "cd /src/tests/helpers/servers &&
  #     FLASK_ENV=development FLASK_APP=dummy_test_helper
  #     flask run --host=0.0.0.0 --port=5001"

  cnmessage_rx_api:
    <<: *base_api_service
    container_name: cnintergov_message_rx_api
    depends_on:
      - cnelasticmq
      - cnminio
    ports: ['6100:5100']
    command: bash -c "cd /src/intergov &&
      FLASK_ENV=development FLASK_APP=apis.message_rx.app
      flask run --host=0.0.0.0 --port=5100"

  cnmessage_api:
    <<: *base_api_service
    container_name: cnintergov_message_api
    depends_on:
      - cnelasticmq
      - cnminio
    ports: ['6101:5101']
    command: bash -c "cd /src/intergov &&
      FLASK_ENV=development FLASK_APP=apis.message.app
      flask run --host=0.0.0.0 --port=5101"

  cnsubscriptions_api:
    <<: *base_api_service
    container_name: cnintergov_subscriptions_api
    ports: ['6102:5102']
    command: bash -c "cd /src/intergov &&
      FLASK_ENV=development FLASK_APP=apis.subscriptions.app
      flask run --host=0.0.0.0 --port=5102"

  cndocument_api:
    <<: *base_api_service
    container_name: cnintergov_document_api
    ports: ['6103:5103']
    command: bash -c "cd /src/intergov &&
      FLASK_ENV=development FLASK_APP=apis.document.app
      flask run --host=0.0.0.0 --port=5103"
    networks:
      - cninternal
      - cnapis_external
      - intercountries

  # backroung processors scripts

  cnproc_inbound_message:
    <<: *base_service
    container_name: cnproc_inbound_message
    restart: on-failure
    environment:
      - PYTHONPATH=/src/
    command: bash -c "cd /src & sleep 8 &&
      python intergov/processors/message_processor/__init__.py"

  cnproc_callbacks_spreader:
    <<: *base_service
    container_name: cnproc_callbacks_spreader
    restart: on-failure
    environment:
      - PYTHONPATH=/src/
    command: bash -c "cd /src & sleep 9 &&
      python intergov/processors/callbacks_spreader/__init__.py"

  cnproc_callback_deliver:
    <<: *base_service
    container_name: cnproc_callback_deliver
    restart: on-failure
    environment:
      - PYTHONPATH=/src/
    command: bash -c "cd /src & sleep 10 &&
      python intergov/processors/callback_deliver/__init__.py"

  cnrejected_messages_processor:
    <<: *base_service
    container_name: cnrejected_messages_processor
    environment:
      - PYTHONPATH=/src/
    command: bash -c "cd /src & sleep 10 &&
      python intergov/processors/rejected_status_updater/__init__.py"

  cnobj_spider:
    <<: *base_service
    container_name: cnobj_spider
    environment:
      - PYTHONPATH=/src/
    command: bash -c "cd /src & sleep 10 &&
      python intergov/processors/obj_spider/__init__.py"
    networks:
      - cninternal
      - intercountries